<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #map-container {
            width: 50%;
            height: 100%;
            border: 1px solid #ccc;
        }

        /* Set the size of the div element that contains the map */
        #map {
            height: 100%;
            /* The height is the full height of the container */
            width: 100%;
            /* The width is the full width of the container */
        }

        .left {
            width: 50%;
            padding: 20px;
            background-color: #f5f5f5;
            border-right: 1px solid #ccc;
        }

        .left h2 {
            margin-top: 0;
        }

        form {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        input[type="button"] {
            padding: 8px 16px;
            background-color: #4caf50;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }

        input[type="button"]:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #rectangle-coordinates,
        #rectangle-perimeter {
            margin-top: 20px;
        }

        #points-container {
            margin-top: 20px;
        }

        #points {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div id="container">
        <div class="left">
            <h2>Teleport To:</h2>
            <form id="teleport-form">
                <label for="latitude">Latitude:</label>
                <input type="text" id="latitude" name="latitude">
                <label for="longitude">Longitude:</label>
                <input type="text" id="longitude" name="longitude">
                <label for="location-select">Or select a location:</label>
                <select id="location-select">
                    <option value="">--Select a Location--</option>
                    <option value="-33.8688,151.2093">Sydney</option>
                    <option value="51.5074,-0.1278">London</option>
                    <option value="40.7128,-74.0060">New York</option>
                </select>
                <label for="grid-size">Grid Size:</label>
                <input type="number" id="grid-size" name="grid-size" min="1">
                <br>
                <input type="button" value="Go" onclick="teleport()">
                <input type="button" id="start" value="Start Demarcate" onclick="startDrawing()">
                <input type="button" id="stop" value="Stop Demarcate" onclick="stopDrawing()" disabled>
                <input type="button" id="reset" value="Reset" onclick="resetDrawing()" disabled>
                <input type="button" id="resize" value="Resize" onclick="resizeMap()" disabled>
                <input type="button" id="choose-points" value="Choose Points" onclick="choosePoints()" disabled>
                <input type="button" id="create-grid" value="Create Grid" onclick="createGrid()" disabled>
            </form>
            <h2>Rectangle coordinates:</h2>
            <div id="rectangle-coordinates"></div>
            <div>
                <h2>Rectangle Perimeter:</h2>
                <div id="rectangle-perimeter"></div>
            </div>
            <div id="points-container">
                <h2>Points:</h2>
                <div id="points"></div>
            </div>
        </div>

        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map, marker, rectangle, drawingManager, infoWindow;
        let points = [];
        let gridLines = [];

        // Initialize the map
        function initMap() {
            const yourPlace = { lat: 44.5452, lng: -78.5389 };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 4,
                center: yourPlace,
                mapTypeId: 'satellite', // Can be any valid type
                scaleControl: true // Adds a scale control
            });
            marker = new google.maps.Marker({ position: yourPlace, map: map });
        }

        // Teleport the map to a given latitude and longitude
        function teleport() {
            const latInput = document.getElementById('latitude').value;
            const lngInput = document.getElementById('longitude').value;
            let position;

            if (latInput && lngInput) {
                position = { lat: parseFloat(latInput), lng: parseFloat(lngInput) };
            } else {
                const selectedLocation = document.getElementById('location-select').value.split(',');
                if (selectedLocation.length === 2) {
                    position = { lat: parseFloat(selectedLocation[0]), lng: parseFloat(selectedLocation[1]) };
                }
            }

            if (position) {
                map.setCenter(position);
                marker.setPosition(position);
            }
        }

        function createGrid() {
            const gridSize = document.getElementById('grid-size').value;
            const bounds = rectangle.getBounds();

            // Disable the "Create Grid" button
            document.getElementById('create-grid').disabled = true;

            // Calculate lat and lng increments based on the size of the grid
            const latIncrement = (bounds.getNorthEast().lat() - bounds.getSouthWest().lat()) / gridSize;
            const lngIncrement = (bounds.getNorthEast().lng() - bounds.getSouthWest().lng()) / gridSize;

            let counter = 1;

            // Place markers on each intersection
            for (let i = 0; i <= gridSize; i++) {
                for (let j = 0; j <= gridSize; j++) {
                    const lat = bounds.getSouthWest().lat() + latIncrement * i;
                    const lng = bounds.getSouthWest().lng() + lngIncrement * j;
                    const point = new google.maps.Marker({
                        position: { lat: lat, lng: lng },
                        map: map,
                        label: `${counter}`
                    });

                    points.push(point);

                    // Update the points display
                    document.getElementById('points').innerHTML += 'Point ' + (points.length) + ': ' + point.position.toString() + '<br>';

                    counter++;
                }
            }

            // Draw grid lines
            for (let i = 0; i <= gridSize; i++) {
                const lat = bounds.getSouthWest().lat() + latIncrement * i;
                const lng = bounds.getSouthWest().lng() + lngIncrement * i;

                // horizontal grid line
                const horizontalLine = new google.maps.Polyline({
                    path: [
                        { lat: lat, lng: bounds.getSouthWest().lng() },
                        { lat: lat, lng: bounds.getNorthEast().lng() }
                    ],
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });

                // vertical grid line
                const verticalLine = new google.maps.Polyline({
                    path: [
                        { lat: bounds.getSouthWest().lat(), lng: lng },
                        { lat: bounds.getNorthEast().lat(), lng: lng }
                    ],
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });

                gridLines.push(horizontalLine, verticalLine);
            }
        }


        // Place the points in the rectangle on the map
        function placePoint(event) {
            const bounds = rectangle.getBounds();

            if (bounds.contains(event.latLng)) {
                const point = new google.maps.Marker({
                    position: event.latLng,
                    map: map,
                    label: `${points.length + 1}`
                });

                points.push(point);

                // Update the points display
                document.getElementById('points').innerHTML += 'Point ' + (points.length) + ': ' + event.latLng.toString() + '<br>';
            } else {
                alert('Point is out of bounds');
            }
        }

        function stopChoosingPoints() {
            google.maps.event.clearListeners(map, 'click');
            document.getElementById('choose-points').disabled = false;
        }


        function choosePoints() {
            // Add a click listener to the map
            map.addListener('click', placePoint);

            // Disable the Choose Points button
            document.getElementById('choose-points').disabled = true;
        }


        function startDrawing() {
            map.setOptions({ disableDefaultUI: true, draggable: true });

            // Calculate bounds around the current center of the map
            let center = map.getCenter();
            const bounds = {
                north: center.lat() + 0.01,
                south: center.lat() - 0.01,
                east: center.lng() + 0.01,
                west: center.lng() - 0.01
            };

            // Create a rectangle and add it to the map
            rectangle = new google.maps.Rectangle({
                bounds: bounds,
                editable: true,
                draggable: true
            });
            rectangle.setMap(map);

            // Add an event listener to update the coordinate display as the rectangle is moved or resized
            rectangle.addListener('bounds_changed', showNewRect);

            // Call the calculatePerimeter function to update the perimeter display
            rectangle.addListener('bounds_changed', calculatePerimeter);

            // Add a click listener to the map
            map.addListener('click', placePoint);


            document.getElementById('start').disabled = true;
            document.getElementById('stop').disabled = false;
            document.getElementById('reset').disabled = false; // Enable the Reset button
            document.getElementById('resize').disabled = true; // Disable the Resize button
            document.getElementById('choose-points').disabled = true; // Disable the Choose Points button



        }

        function stopDrawing() {
            rectangle.setOptions({ disableDefaultUI: false, draggable: false, editable: false });
            map.setOptions({ disableDefaultUI: false, draggable: false, draggableCursor: '' });

            // Do not clear the map click event listener here. It's now handled by stopChoosingPoints()
            google.maps.event.clearListeners(rectangle, 'bounds_changed');

            // Add a click listener to the map
            rectangle.addListener('click', placePoint);

            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
            document.getElementById('reset').disabled = false; // Keep the Reset button enabled
            document.getElementById('resize').disabled = false; // Enable the Resize button
            document.getElementById('choose-points').disabled = false; // Enable the Choose Points button
            document.getElementById('create-grid').disabled = false; // Enable the Create Grid button
        }


        function resetDrawing() {
            // Remove the rectangle from the map
            if (rectangle) {
                rectangle.setMap(null);
                rectangle = null;
            }

            // Re-enable the Start button and disable the Stop and Reset buttons
            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
            document.getElementById('reset').disabled = true;

            // Clear the coordinate display
            document.getElementById('rectangle-coordinates').innerText = '';
            document.getElementById('resize').disabled = true; // Disable the Resize button

            document.getElementById('choose-points').disabled = true; // Disable the Choose Points button

            // Remove the points from the map
            for (let i = 0; i < points.length; i++) {
                points[i].setMap(null);
            }

            // Clear the points array and the points display
            points = [];
            document.getElementById('points').innerHTML = '';

            // Stop choosing points
            stopChoosingPoints();

            // Remove the grid lines from the map
            for (let i = 0; i < gridLines.length; i++) {
                gridLines[i].setMap(null);
            }

            // Clear the grid lines array
            gridLines = [];
            // Enable the "Create Grid" button
            document.getElementById('create-grid').disabled = false;

        }


        /** Show the new coordinates for the rectangle in an info window. */
        function showNewRect() {

            // Calculate the NE and SW corners
            const ne = rectangle.getBounds().getNorthEast();
            const sw = rectangle.getBounds().getSouthWest();

            // Calculate the NW and SE corners
            const nw = new google.maps.LatLng(ne.lat(), sw.lng());
            const se = new google.maps.LatLng(sw.lat(), ne.lng());

            // Update the coordinate display
            document.getElementById('rectangle-coordinates').innerHTML =
                'NE: ' + ne.toString() + '<br>' +
                'NW: ' + nw.toString() + '<br>' +
                'SW: ' + sw.toString() + '<br>' +
                'SE: ' + se.toString();
        }

        // Calculate the perimeter of the rectangle
        function calculatePerimeter() {
            const ne = rectangle.getBounds().getNorthEast();
            const nw = new google.maps.LatLng(ne.lat(), rectangle.getBounds().getSouthWest().lng());
            const sw = rectangle.getBounds().getSouthWest();
            const se = new google.maps.LatLng(sw.lat(), rectangle.getBounds().getNorthEast().lng());

            const latPerimeter = google.maps.geometry.spherical.computeDistanceBetween(sw, nw); // Perimeter along latitude in meters
            const lngPerimeter = google.maps.geometry.spherical.computeDistanceBetween(nw, ne); // Perimeter along longitude in meters

            const perimeter = 2 * (latPerimeter + lngPerimeter); // Perimeter in meters

            document.getElementById('rectangle-perimeter').innerHTML = '<p>Perimeter is: <strong>' + perimeter.toLocaleString() + ' meters&sup2;</strong></p>';
        }

        // Resize the rectangle to fit the viewport
        function resizeMap() {
            // Get the bounds of the rectangle
            const bounds = rectangle.getBounds();

            // Adjust the map's viewport to fit the rectangle
            map.fitBounds(bounds);
        }


        window.initMap = initMap;

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap">
    </script>
    </div>
</body>

</html>